<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üìç GPS Tracker Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: #f0f0f0;
    }
    header {
      padding: 1rem;
      background: #1a1a1a;
      text-align: center;
      font-size: 2rem;
      color: #00ffea;
    }
    #map {
      height: 55vh;
      width: 100%;
      border-bottom: 2px solid #00ffea;
    }
    .stats {
      padding: 1rem;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background: #111;
    }
    .stat {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 1rem;
      margin: 1rem;
      box-shadow: 0 0 10px #00ffc3;
      min-width: 150px;
    }
    .speedometer {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }
    canvas {
      background: #111;
      border-radius: 10px;
      box-shadow: 0 0 15px #00ffc3;
    }
    .controls {
      padding: 1rem;
      text-align: center;
    }
    button {
      background: #00ffea;
      border: none;
      padding: 0.5rem 1rem;
      margin: 0.5rem;
      color: #000;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
    }
  </style>
</head>
<body>
  <header>üìç GPS Tracker Dashboard</header>
  <div id="map"></div>
  <div class="stats">
    <div class="stat" id="start-point">Start Point: N/A</div>
    <div class="stat" id="end-point">End Point: N/A</div>
    <div class="stat" id="top-speed">Top Speed: 0 km/h</div>
    <div class="stat" id="avg-speed">Average Speed: 0 km/h</div>
    <div class="stat" id="distance">Distance: 0 km</div>
  </div>
  <div class="speedometer">
    <canvas id="speedMeter" width="150" height="150"></canvas>
    <canvas id="avgMeter" width="150" height="150"></canvas>
  </div>
  <div class="controls">
    <button onclick="exportGPX()">üì§ Export GPX</button>
    <button onclick="exportKML()">üì§ Export KML</button>
    <button onclick="replayRoute()">‚è™ Replay Route</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIhBp0RUkoEoSISBBpqXq6xpHPDH_8PTA",
      authDomain: "gpstracker-9be3a.firebaseapp.com",
      databaseURL: "https://gpstracker-9be3a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gpstracker-9be3a",
      storageBucket: "gpstracker-9be3a.appspot.com",
      messagingSenderId: "xxx",
      appId: "xxx"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("trackers/device1");

    let map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
      attribution: 'Google'
    }).addTo(map);

    const routePoints = [];
    let marker = null, startLatLng = null;
    let totalSpeed = 0, topSpeed = 0, totalDistance = 0, points = 0, lastLatLng = null;
    const polyline = L.polyline([], {
      color: '#00fff2',
      dashArray: '10, 6',
      weight: 5
    }).addTo(map);

    function drawMeter(canvasId, value, label) {
      const ctx = document.getElementById(canvasId).getContext('2d');
      ctx.clearRect(0, 0, 150, 150);
      ctx.beginPath();
      ctx.arc(75, 75, 60, 0, Math.PI * 2);
      ctx.strokeStyle = '#444';
      ctx.lineWidth = 10;
      ctx.stroke();
      ctx.beginPath();
      ctx.arc(75, 75, 60, -Math.PI / 2, (value / 150) * 2 * Math.PI - Math.PI / 2);
      ctx.strokeStyle = '#00ffea';
      ctx.lineWidth = 10;
      ctx.stroke();
      ctx.font = '16px Arial';
      ctx.fillStyle = '#fff';
      ctx.fillText(label, 40, 75);
      ctx.fillText(value.toFixed(1) + ' km/h', 30, 100);
    }

    function updateMeters() {
      drawMeter('speedMeter', topSpeed, 'Top Speed');
      drawMeter('avgMeter', totalSpeed / points, 'Avg Speed');
    }

    function exportGPX() {
      let gpx = `<?xml version="1.0"?><gpx version="1.1" creator="Kukur Tracker"><trk><name>Route</name><trkseg>`;
      for (const pt of routePoints) {
        gpx += `<trkpt lat="${pt[0]}" lon="${pt[1]}"></trkpt>`;
      }
      gpx += `</trkseg></trk></gpx>`;
      const blob = new Blob([gpx], {type: 'application/gpx+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'route.gpx';
      a.click();
    }

    function exportKML() {
      let kml = `<?xml version="1.0"?><kml xmlns="http://www.opengis.net/kml/2.2"><Document><Placemark><LineString><coordinates>`;
      for (const pt of routePoints) {
        kml += `${pt[1]},${pt[0]},0\n`;
      }
      kml += `</coordinates></LineString></Placemark></Document></kml>`;
      const blob = new Blob([kml], {type: 'application/vnd.google-earth.kml+xml'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'route.kml';
      a.click();
    }

    async function replayRoute() {
      if (routePoints.length === 0) return;
      polyline.setLatLngs([]);
      for (const latlng of routePoints) {
        marker.setLatLng(latlng);
        polyline.addLatLng(latlng);
        map.panTo(latlng);
        await new Promise(res => setTimeout(res, 500));
      }
    }

    db.on('value', snap => {
      const data = snap.val();
      if (!data || !data.lat || !data.lon) return;

      const lat = data.lat;
      const lon = data.lon;
      const speed = data.speed || 0;
      const latlng = [lat, lon];
      routePoints.push(latlng);

      if (!marker) {
        marker = L.marker(latlng).addTo(map);
        startLatLng = latlng;
        document.getElementById('start-point').innerText = `Start Point: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      } else {
        marker.setLatLng(latlng);
      }

      polyline.addLatLng(latlng);
      map.setView(latlng, 16);

      totalSpeed += speed;
      topSpeed = Math.max(topSpeed, speed);
      points++;

      if (lastLatLng) {
        const dist = map.distance(lastLatLng, latlng) / 1000;
        totalDistance += dist;
      }
      lastLatLng = latlng;

      document.getElementById('end-point').innerText = `End Point: ${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      document.getElementById('top-speed').innerText = `Top Speed: ${topSpeed.toFixed(2)} km/h`;
      document.getElementById('avg-speed').innerText = `Average Speed: ${(totalSpeed / points).toFixed(2)} km/h`;
      document.getElementById('distance').innerText = `Distance: ${totalDistance.toFixed(2)} km`;

      updateMeters();
    });
  </script>
</body>
</html>
