<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ðŸš— Car HUD GPS Dashboard</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    :root {
      --bg: #000000;
      --text: #00ffcc;
      --accent: #00f7ff;
      --gauge-bg: #111;
    }
    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: 'Orbitron', sans-serif;
    }
    header {
      text-align: center;
      padding: 0.5rem;
      font-size: 1.5rem;
      color: var(--accent);
      background-color: #111;
    }
    #map {
      height: 300px;
      filter: brightness(1.2);
    }
    .gauges {
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      background: var(--gauge-bg);
      padding: 1rem;
    }
    canvas.speed-meter {
      width: 220px;
      height: 220px;
    }
    .info {
      display: flex;
      justify-content: space-evenly;
      background: #111;
      padding: 1rem;
    }
    .info div {
      text-align: center;
      flex: 1;
    }
    .chart {
      padding: 1rem;
    }
    @media (max-width: 768px) {
      .gauges {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>
<body>
  <header>
    ðŸš€ CAR HUD DASHBOARD
  </header>

  <div id="map"></div>
  <div class="gauges">
    <canvas id="topSpeedMeter" class="speed-meter"></canvas>
    <canvas id="avgSpeedMeter" class="speed-meter"></canvas>
  </div>

  <div class="info">
    <div id="start-point">Start: --</div>
    <div id="end-point">End: --</div>
    <div id="distance">Distance: 0 km</div>
  </div>

  <div class="chart">
    <canvas id="speedChart"></canvas>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBIhBp0RUkoEoSISBBpqXq6xpHPDH_8PTA",
      authDomain: "gpstracker-9be3a.firebaseapp.com",
      databaseURL: "https://gpstracker-9be3a-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "gpstracker-9be3a",
      storageBucket: "gpstracker-9be3a.appspot.com",
      messagingSenderId: "xxx",
      appId: "xxx"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database().ref("trackers/device1");

    const map = L.map('map').setView([20.5937, 78.9629], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 20
    }).addTo(map);

    let marker, startMarker, endMarker;
    const trail = L.polyline([], { color: '#00ffff', weight: 5 }).addTo(map);
    let totalDistance = 0, topSpeed = 0, totalSpeed = 0, count = 0, lastLatLng;
    const speedData = [], speedTime = [];

    const speedChart = new Chart(document.getElementById("speedChart"), {
      type: 'line',
      data: {
        labels: speedTime,
        datasets: [{
          label: 'Speed (km/h)',
          data: speedData,
          borderColor: 'cyan',
          backgroundColor: 'transparent',
          tension: 0.3
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    function drawGauge(canvasId, value, maxVal) {
      const canvas = document.getElementById(canvasId);
      const ctx = canvas.getContext("2d");
      const w = canvas.width = canvas.offsetWidth;
      const h = canvas.height = canvas.offsetHeight;
      const cx = w / 2, cy = h / 2, r = Math.min(cx, cy) - 10;

      ctx.clearRect(0, 0, w, h);
      ctx.beginPath();
      ctx.arc(cx, cy, r, Math.PI, 0);
      ctx.strokeStyle = '#222';
      ctx.lineWidth = 12;
      ctx.stroke();

      ctx.beginPath();
      ctx.arc(cx, cy, r, Math.PI, Math.PI + (Math.PI * value / maxVal));
      ctx.strokeStyle = '#00f7ff';
      ctx.lineWidth = 12;
      ctx.stroke();

      ctx.fillStyle = 'white';
      ctx.font = "bold 20px Orbitron";
      ctx.textAlign = "center";
      ctx.fillText(value.toFixed(1) + " km/h", cx, cy + 10);
    }

    function update(lat, lon, speed) {
      const latlng = [lat, lon];
      if (!marker) {
        marker = L.marker(latlng).addTo(map);
        startMarker = L.marker(latlng).addTo(map);
        document.getElementById('start-point').innerText = `Start: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      } else {
        marker.setLatLng(latlng);
        if (endMarker) map.removeLayer(endMarker);
        endMarker = L.marker(latlng).addTo(map);
        document.getElementById('end-point').innerText = `End: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
      }
      trail.addLatLng(latlng);
      map.setView(latlng);

      if (lastLatLng) {
        const dist = map.distance(lastLatLng, latlng) / 1000;
        totalDistance += dist;
      }
      lastLatLng = latlng;

      totalSpeed += speed;
      topSpeed = Math.max(topSpeed, speed);
      count++;
      speedData.push(speed);
      speedTime.push(new Date().toLocaleTimeString());
      if (speedData.length > 25) {
        speedData.shift();
        speedTime.shift();
      }
      speedChart.update();

      const avg = totalSpeed / count;
      drawGauge("topSpeedMeter", topSpeed, 120);
      drawGauge("avgSpeedMeter", avg, 120);
      document.getElementById('distance').innerText = `Distance: ${totalDistance.toFixed(2)} km`;
    }

    db.on('value', snap => {
      const d = snap.val();
      if (!d || !d.lat || !d.lon) return;
      update(d.lat, d.lon, d.speed || 0);
    });
  </script>
</body>
</html>
